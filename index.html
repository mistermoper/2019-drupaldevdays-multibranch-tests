<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Multibranch tests with Drupal, Jenkins and Docker | DrupalDevDays 2019</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css">
		<link rel="stylesheet" href="css/custom.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="sponsor">
			<img src="assets/images/event-logo.png" class="logo"/><span>Multibranch tests with Drupal , Jenkins and Docker<strong>@omarlopesino</strong> | http://tiny.cc/ufsw6y</span>
		</div>
		<div class="reveal">
			<div class="slides">

				<!-- Cover -->
				<section data-background-transition="slide" data-background="assets/images/background-front.png" class="left">
					<div class="left">
						<img src="assets/images/event-logo.png" class="medium"/>
					</div>
					<div class="featured-box-primary left">
						<h1>Multibranch tests with Drupal , Jenkins and Docker</h1>
						<em>Quality assurance development workflow</em>
						<div class="xxsmall">http://goo.gl/@TODO</div>
					</div>

					<div class="featured-box-secondary left xsmall">
						Omar Lopesino /
						<span class="small">@omarlopesino</span>
					</div>

					<div class="featured-box-primary left xsmall inline-block" style="float:right">
						#DrupalDevDays
					</div>

				</section>

				<!-- Personal presentation -->
				<section data-background="assets/images/background-secondary.png">
					<div><img src="assets/images/personal-square.jpg" class="profile-photo"></div>
					<h4>Omar Lopesino</h4>
					<div class="xsmall"><em>Drupal Developer</em></div>
					<div class="small"><a href="https://twitter.com/omarlopesino" target="_blank">@omarlopesino</a></div>
					<p class="xsmall"><a href="https://drupal.org/u/mistermoper" target="_blank">drupal.org/u/mistermoper</a><br><span class="xsmall">Contributed modules: entity_statistics, slickquiz_field...</span></p>
					<img src="assets/images/metadrop-logo.svg" class="metadrop-logo">
				</section>

				<!-- START -->

				<section>
					<p class="medium left"><em>In this session we will see:</em></p>
					<ol>
						<li>Why multibranch testing?</li>
						<li>Jenkins multibranch testing example</li>
						<li>How to Jenkins multibranch</li>
						<li>Live example</li>
						<li>What more can we do?</li>
					</ol>
				</section>


				<section data-background="assets/images/background-secondary.png" data-background-image="assets/images/background-secondary.png" class="present" style="top: 253px; display: block;">
					<em>First</em>
					<h2>Why multibranch testing</h2>
				</section>

				<section>
					<h2>Objective</h2>
					<img src="assets/images/objective.png">
				</section>

				<section>
					<h2>Branch model</h2>
					<img src="assets/images/git-model.png">
					<p> Source: <a href="https://backlog.com/git-tutorial/branching-workflows/" target="_blank">Branching workflows</a></p>
				</section>

				<section>
					<h2>What to test</h2>
					<img src="assets/images/what-to-test-2.png">
				</section>

				<section>
					<h2>But should I have to run all these tests manually?</h2>
					<img src="assets/images/animal-2029675_960_720.png" class="width-300">
				</section>


				<section>
					<h2>Jenkins to the rescue!</h2>
					<img src="assets/images/JenkinsRescue.png"  style="width:800px">
				</section>

				<section>
					<h2>Parallel testing</h2>
					<img src="assets/images/parallel-testing.png">
					<img class="fragment fade-in" src="assets/images/docker.png">
				</section>

				<section data-background="assets/images/background-secondary.png" data-background-image="assets/images/background-secondary.png" class="present" style="top: 253px; display: block;">
					<em>Second</em>
					<h2>Jenkins multibranch testing example</h2>
				</section>

				<section>
					<p class="medium left"><em>Jenkins multibranch testing example</em></p>
					<p class="small center">Automated tests for each git repository branch.</p>
					<img src="assets/images/automated-tests-bitbucket.jpg">
				</section>

				<section>
					<p class="medium left"><em>Jenkins multibranch testing example</em></p>
					<p class="small center">Automated tests for each git repository branch.</p>
					<img src="assets/images/automated-tests.jpg">
				</section>
	
				<section>
					<p class="medium left"><em>Jenkins multibranch testing example</em></p>
					<p class="small center">Automated tests for each git repository branch.</p>
					<img src="assets/images/what-to-test-jenkins.jpg">
				</section>

				<section>
					<p class="medium left"><em>Jenkins multibranch testing example</em></p>
					<p class="small center">Automated tests for each git repository branch.</p>
					<img src="assets/images/what-to-test-2.png">
				</section>

				<section>
					<p class="medium left"><em>Jenkins multibranch testing example</em></p>
					<p class="xsmall left"><em>Notification</em></p>
					<img src="assets/images/notified.jpg">
				</section>

				<section>
					<p class="medium left"><em>Jenkins multibranch testing example</em></p>
					<p class="xsmall left"><em>Code static analysis</em></p>
					<img src="assets/images/checkstyle-warnings.jpg">
				</section>

				<section>
					<p class="medium left"><em>Jenkins multibranch testing example</em></p>
					<p class="xsmall left"><em>Test results (junit)</em></p>
					<img src="assets/images/test-result.jpg">
				</section>

				<section data-background="assets/images/background-secondary.png" data-background-image="assets/images/background-secondary.png" class="present" style="top: 253px; display: block;">
					<em>Third</em>
					<h2>How to Jenkins multibranch</h2>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="bold big center"><em>Which tools do we need?</em></p>
					<div class="requirements container">
						<div class="fragment fade-in docker">
							<div>
								<img src="assets/images/docker.png">
							</div>
							<ul class="small">
								<li>Docker</li>
								<li>Docker compose</li>
							</ul>
						</div>
						<div class="fragment fade-in jenkins">
							<div>
								<img src="assets/images/Jenkins_8.png">
							</div>
							<ul class="small">
								<li>Jenkins job</li>
							</ul>
						</div>
					</div>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<div class="container">
					<ol>
						<li class="small left">Develop a docker infraestructure for drupal</p>
						<li class="small left">Create Jenkins pipeline</p>
						<li class="small left">Create Jenkins multibranch pipeline job</p>
					</ol>

						<img src="assets/images/building-blocks.png" class="width-300">
					</div>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="small left">Develop a docker infraestructure for drupal</p>
					<div class="container">
						<img class="width-400" src="assets/images/php.jpg">
						<img class="width-400" src="assets/images/mariadb.png">
						<img class="width-300" src="assets/images/nginx.png">
					</div>
					<p class="left">Example: <a class="left" href="https://github.com/wodby/docker4drupal">Docker4Drupal</a></p>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="medium left"><em>Create Jenkins multibranch pipeline job</em></p>
					<ul>
						<li>Pipeline job code-written</li>
						<li>Committed in repository</li>
					</ul>
					<img src="assets/images/what-to-test-jenkins.jpg">
					<div>
						<a href="https://jenkins.io/doc/book/pipeline/" target="_blank">Source</a>
					</div>
				</section>

				<section>
					<blockquote>Talk is cheap. Show me the code</blockquote>
					<img title="Talk is cheap. Show me the code" alt="Talk is cheap. Show me the code" class="width-200" src="assets/images/boy-2022559_960_720.png">
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="medium left"><em>Create Jenkins multibranch pipeline job: Skeleton</em></p>
					<div class="container">
					<pre><code class="small groovy hljs">pipeline {
    agent any
    stages {
        stage('Docker start') { ... }
        stage('Composer') { ... }
        stage('Static Analysis') { ... }
        stage('Unit tests') { ... }
        stage('Database sync') { ... }
        stage('Functional tests') { ... }
    }
    post { ... }
}</code></pre>
				<img src="assets/graphs/how-to/pipeline-skeleton.png">
				</div>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="medium left"><em>Create Jenkins multibranch pipeline job: Docker start</em></p>
					<div class="container">
					<pre><code class="small groovy hljs has-highlights" data-trim data-line-numbers="4-6">pipeline {
    agent any
    stages {
        stage('Docker start') {
            sh "docker-compose up -d"	
        }
    }
}</code></pre>

				<img src="assets/graphs/how-to/pipeline-setup-environment.png">
				</div>
				</section>
				
				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="medium left"><em>Create Jenkins multibranch pipeline job: Composer</em></p>
					<div class="container">
					<pre><code class="small groovy hljs" data-trim data-line-numbers="5-7">pipeline {
    agent any
    stages {
        stage('Docker start') { ... }
        stage('Composer') {
            sh "docker-compose exec php -T composer install"
        }
    }
}</code></pre>
				<img src="assets/graphs/how-to/pipeline-setup-environment.png">
				</div>
</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="medium left"><em>Creating Jenkinsfile: Static analysis</em></p>
					<div class="container">
					<pre><code class="small groovy hljs" data-trim data-line-numbers="6-9">pipeline {
    agent any
    stages {
        stage('Docker start') { ... }
        stage('Composer') { ... }
        stage('Static Analysis') {
          sh "docker-compose exec php -T 
            ./vendor/bin/phpcs --standard=Drupal,DrupalPractice"
        }
    }
}</code></pre>
				<img src="assets/graphs/how-to/pipeline-static-analysis.png">
				</div>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="medium left"><em>Creating Jenkinsfile: Unit tests</em></p>
					<div class="container">
					<pre><code class="small groovy hljs" data-trim data-line-numbers="7-10">pipeline {
    agent any
    stages {
        stage('Docker start') { ... }
        stage('Composer') { ... }
        stage('Static Analysis') { ... }
        stage('Unit tests') {
          sh "docker-compose exec php -T 
            ./vendor/bin/phpunit -c phpunit.xml"
        }
    }
}</code></pre>
				<img src="assets/graphs/how-to/pipeline-unit-tests.png">
				</div>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="medium left"><em>Creating Jenkinsfile: Database sync</em></p>
					<div class="container">
					<pre><code class="small groovy hljs" data-line-numbers="8-11">pipeline {
    agent any
    stages {
        stage('Docker start') { ... }
        stage('Composer') { ... }
        stage('Static Analysis') { ... }
        stage('Unit tests') { ... }
        stage('Database sync') {
          sh "drush @my-environment sql:sync"
          // drush updb, cim, cr, file sync..
        }
    }
}</code></pre>
				<img src="assets/graphs/how-to/pipeline-database-sync.png">
				</div>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="medium left"><em>Creating Jenkinsfile: Functional tests</em></p>
					<div class="container">
					<pre><code class="small groovy hljs" data-line-numbers="9-12">pipeline {
    agent any
    stages {
        stage('Docker start') { ... }
        stage('Composer') { ... }
        stage('Static Analysis') { ... }
        stage('Unit tests') { ... }
        stage('Database sync') { ... }
        stage('Functional tests') {
          sh "docker-compose exec php -T 
            vendor/bin/behat --config tests/behat/behat.yml"
        }
    }
}</code></pre>
				<img src="assets/graphs/how-to/pipeline-functional-tests.png">
				</div>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="medium left"><em>Creating Jenkinsfile: Post steps</em></p>
					<div class="container">
					<pre><code class="small groovy hljs" data-line-numbers="4-15">pipeline {
    agent any
    stages { ... }
    post {
      allways {
        sh "docker-compose down"
      }
      success {
        slackSend color: "#00FF00", 
          channel: "#myproject",
          message: "Tests passes, hurray!"
      }
      failure { ... }
      changed { ... }
    }
}</code></pre>
				<img src="assets/graphs/how-to/pipeline-post.png">
				</div>
				</section>

				<section>
					<p class="medium left"><em>How to Jenkins multibranch</em></p>
					<p class="small left"><em><a target="_blank" href="https://wiki.jenkins.io/display/JENKINS/Pipeline+Multibranch+Plugin">Create multibranch pipeline job</a></em></p>
					<img class="width-300" src="assets/images/blocks-1295126_960_720.png">
				</section>

				<section>
					<video controls>
						<source src="assets/videos/CreatingMultibranch.webm">
					</video>
				</section>

				<section data-background="assets/images/background-secondary.png" data-background-image="assets/images/background-secondary.png" class="present" style="top: 253px; display: block;">
					<em>Fourth</em>
					<h2>Live example</h2>
					<img class="width-300" src="assets/images/arm-2029406_960_720.png">
				</section>

				<section>
					<p class="medium left"><em>Live example</em></p>
					<ul>
						<li>Allow editors edit any article</li>
						<li>Accidentally enable delete any article permission.</li>
					</ul>
					<img class="width-300" src="assets/images/drive-2029742_960_720.png">
				</section>

				<section>
					<p class="medium left"><em>Live example</em></p>
					<video controls>
						<source src="assets/videos/live-example/live-example.webm">
					</video>
				</section>

				<section>
					<p class="medium left"><em>Live example</em></p>
					<img src="assets/images/fail-notified.jpg">
				</section>

				<section data-background="assets/images/background-secondary.png" data-background-image="assets/images/background-secondary.png" class="present" style="top: 253px; display: block;">
					<em>Fifth</em>
					<h2>What more can we do?</h2>
				</section>

				<section>
					<p class="medium left"><em>What more can we do?</em></p>
					<ul>
						<li>Rest services: Postman tests automated with newman</li>
					</ul>
					<div class="center">
						<img class="width-300 center" src="assets/images/postman.png">
					</div>
				</section>

				<section>
					<p class="medium left"><em>What more can we do?</em></p>
					<ul>
						<li>Rest services: Postman tests automated with newman</li>
						<li>Check updates: modules, security updates.</li>
						<img src="assets/images/php-73.jpg">
					</ul>
				</section>

				<section>
					<p class="xsmall left"><em>What more can we do?</em></p>
					<p class="small left"><em>Patches applied in our site</em></p>
					<div class="fragment fade-in">
						<a target="_blank" href="https://dispatcher.drupalci.org/">Drupal CI</a>
						<img src="assets/images/jenkins-ci.jpg">
					</div>
				</section>


				<section>
						<h1>Conclusions</h1>
						<p class="medium left">Development of a system that brings:</p>
						<ul class="small">
							<li><strong>Quality assurance</strong> of the project based on git branches.</li>
							<li>Method used for detect regressions that allows <strong>fail early</strong>.</li>
							<li><strong>Automated and integrated</strong> tests.</li>
						</ul>
				</section>

				<section data-background="assets/images/background-primary.png">
					<h3>Any questions?</h3>
				</section>

				<section data-background="assets/images/background-primary.png">
					<h4>Thanks!!!</h4>
					<div class="small white">@omarlopesino</div>
					<div><img src="assets/images/metadrop-logo-white.svg" class="medium"></div>
					<div><img src="assets/images/event-logo.png" class="medium"/></div>
				</section>

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true },
					{ src: 'plugin/search/search.js', async: true },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});
		</script>
	</body>
</html>
